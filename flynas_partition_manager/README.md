# 飞牛NAS智能分区管理工具 v3.0

## 📋 简介

这是一个功能强大的通用分区管理工具，可以灵活地调整和管理磁盘分区。

**主要用途**：
- 动态检测所有分区
- 灵活调整任意分区大小
- 支持多种文件系统
- 识别未分配空间

**核心脚本**：`flynas_partition_manager_v3_complete.sh`

---

## 🎯 主要功能

### 1. 智能分区检测

- ✅ 自动检测所有分区（vda1/2/3/4...）
- ✅ 识别分区文件系统（ext4/xfs/btrfs）
- ✅ 显示分区大小和使用情况
- ✅ 识别挂载点和角色

### 2. 灵活分区调整

- ✅ 用户选择任意源分区
- ✅ 用户选择任意目标分区
- ✅ 智能计算可用空间
- ✅ 提供调整建议

### 3. 文件系统支持

| 文件系统 | 缩小 | 扩展 | 状态 |
|---------|------|------|------|
| ext4 | ✅ | ✅ | 完全支持 |
| xfs | ❌ | ✅ | 仅支持扩展 |
| btrfs | ✅ | ✅ | 完全支持 |

### 4. 安全保障

- ✅ 两阶段操作（准备+执行）
- ✅ 完整的安全检查
- ✅ 详细的日志记录
- ✅ 清晰的状态追踪

---

## 🚀 使用步骤

### 步骤1：准备

```bash
# 上传脚本
scp flynas_partition_manager_v3_complete.sh root@your-server:/root/

# 添加执行权限
chmod +x flynas_partition_manager_v3_complete.sh
```

### 步骤2：执行脚本

```bash
sudo ./flynas_partition_manager_v3_complete.sh
```

### 步骤3：选择源分区

```
╔══════════════════════════════════════════════════════════╗
║         飞牛NAS智能分区管理工具 v3.0 完整版              ║
╚══════════════════════════════════════════════════════════╝

[信息] 检测到的分区：

分区  大小   已用    可用    使用率  文件系统  挂载点     角色
------------------------------------------------------------
vda1  120G   8.0G    112G    8%      ext4      /          系统分区
vda2  -      -       -       -       -         -          未格式化

[信息] 未分配空间: 0GB

请选择要缩小的源分区（输入分区号，如1）: 1    ← 选择vda1
```

### 步骤4：输入缩小大小

```
[信息] 分区 vda1 信息：
  总大小: 120GB
  已使用: 8GB
  文件系统: ext4 ✓ 支持缩小

请输入要缩小的大小（GB）: 100    ← 缩小100GB
```

### 步骤5：选择目标分区

```
请选择目标分区或操作：
1) 扩展到 vda2
2) 创建新分区

请选择（1-2）: 1    ← 选择扩展到vda2
```

### 步骤6：确认操作

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          操作摘要
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

源分区: vda1
  - 缩小: 100GB
  - 新大小: 20GB

目标分区: vda2
  - 扩展: 100GB

确认执行？(输入 YES): YES
```

### 步骤7：两阶段执行

```
阶段1: 准备阶段（当前系统）
  ✓ 安全检查
  ✓ 备份配置
  ✓ 创建执行脚本

阶段2: 执行阶段（重启后）
  ✓ 系统服务自动执行
  ✓ 调整分区
  ✓ 更新配置

是否立即重启？(y/n): y
```

---

## 📊 工作原理

### 两阶段操作

```
阶段1（准备）- 当前系统：
├─ 检测所有分区
├─ 验证操作可行性
├─ 计算空间分配
├─ 创建systemd服务
├─ 创建执行脚本
└─ 备份关键配置

阶段2（执行）- 重启后：
├─ systemd服务启动
├─ 检查文件系统
├─ 缩小源分区文件系统
├─ 调整分区表
├─ 扩展目标分区
├─ 扩展目标文件系统
├─ 更新fstab
└─ 标记完成
```

### 智能检测

```bash
# 检测分区
lsblk /dev/vda

# 检测文件系统
blkid /dev/vda*

# 检测挂载点
df -h

# 检测使用情况
du -sh /
```

---

## 🔧 支持的操作

### 1. 缩小分区

**支持的文件系统**：
- ✅ ext4
- ✅ btrfs
- ❌ xfs（不支持）

**操作流程**：
```bash
e2fsck -f /dev/vdaX
resize2fs /dev/vdaX [新大小]
parted /dev/vda resizepart X [新结束位置]
```

### 2. 扩展分区

**支持的文件系统**：
- ✅ ext4
- ✅ xfs
- ✅ btrfs

**操作流程**：
```bash
parted /dev/vda resizepart X [新结束位置]
resize2fs /dev/vdaX  # ext4
xfs_growfs /mount/point  # xfs
btrfs filesystem resize max /mount/point  # btrfs
```

### 3. 创建新分区

```bash
parted /dev/vda mkpart primary ext4 [起始] [结束]
mkfs.ext4 /dev/vdaX
```

---

## 📁 相关文件

### 主脚本
- `flynas_partition_manager_v3_complete.sh` - 主脚本

### 日志文件
- `/var/log/flynas_partition_manager.log` - 主日志
- `/var/log/flynas_partition_exec.log` - 执行日志

### 状态文件
- `/var/lib/flynas_partition_state_v3` - 状态标记

---

## 💡 使用场景

### 场景1：从系统分区划分存储空间

```
vda1 (120GB系统) → 缩小100GB → vda1 (20GB系统) + vda2 (100GB存储)
```

使用此工具：
1. 选择vda1作为源分区
2. 缩小100GB
3. 扩展到vda2或创建新分区

### 场景2：调整现有分区

```
vda1 (50GB) + vda2 (70GB) → vda1 (30GB) + vda2 (90GB)
```

使用此工具：
1. 选择vda1作为源分区
2. 缩小20GB
3. 扩展到vda2

### 场景3：创建多个分区

```
vda1 (120GB) → vda1 (40GB) + vda2 (40GB) + vda3 (40GB)
```

多次使用此工具调整。

---

## ⚠️ 注意事项

### 操作前

1. ✅ **完整备份数据**
2. ✅ **创建虚拟机快照**（如果可能）
3. ✅ **确认文件系统类型**
4. ✅ **计算好空间分配**

### 操作中

1. ⚠️ 不要强制关机
2. ⚠️ 不要中断执行
3. ⚠️ 观察日志输出

### 操作后

1. ✅ 验证分区状态
2. ✅ 检查文件系统
3. ✅ 测试挂载点

---

## 🔧 故障排除

### 问题1：xfs文件系统无法缩小

**原因**：xfs不支持缩小

**解决**：
- 方案1：使用ext4重新格式化
- 方案2：备份数据后重建分区

### 问题2：分区正在使用

**原因**：分区已挂载

**解决**：
- 工具会自动尝试remount ro
- 或在重启后的执行阶段处理

### 问题3：空间计算错误

**检查**：
```bash
# 查看分区详情
sudo parted /dev/vda unit GB print

# 查看文件系统使用
df -h

# 查看实际占用
du -sh /
```

---

## 📊 与存储创建工具的区别

| 特性 | 存储创建工具 | 分区管理工具 |
|------|-------------|-------------|
| 用途 | 专门创建存储分区 | 通用分区管理 |
| 灵活性 | 固定流程 | 高度灵活 |
| 源分区 | 仅vda1 | 任意分区 |
| 目标 | 创建vda2 | 任意操作 |
| 文件系统 | ext4 | ext4/xfs/btrfs |
| 适用场景 | 初次配置 | 后续调整 |

---

## ✅ 优势

1. **灵活性高**
   - 支持任意分区调整
   - 多种文件系统
   - 灵活的操作选择

2. **智能化**
   - 自动检测分区
   - 智能计算空间
   - 提供调整建议

3. **安全性好**
   - 两阶段操作
   - 完整检查
   - 详细日志

4. **通用性强**
   - 不限于飞牛NAS
   - 适用于各种Linux系统
   - 支持多种场景

---

## 📞 总结

flynas_partition_manager v3.0是一个**强大而灵活**的分区管理工具，适合：

- ✅ 需要灵活调整分区的场景
- ✅ 管理多个分区
- ✅ 支持多种文件系统
- ✅ 复杂的空间调整需求

**推荐用于**：
- 系统已运行一段时间，需要重新规划分区
- 需要在多个分区间调整空间
- 需要支持xfs/btrfs等文件系统
